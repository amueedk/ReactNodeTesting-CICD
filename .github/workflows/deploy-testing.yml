name: Deploy to Testing Environment

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-testing:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install

    - name: Build application
      run: npm run build-react

    - name: Run unit tests
      run: npm test -- --watchAll=false

    - name: Run linting
      run: npx eslint src/ || echo "Lint warnings ignored"

    - name: Deploy PR code to Testing EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TESTING_EC2_IP }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.TESTING_SSH_KEY }}
        script: |
          if [ ! -d "ReactNodeTesting-CICD" ]; then
            git clone https://github.com/${{ github.repository }}.git
          fi
          cd ReactNodeTesting-CICD
          git fetch origin
          git checkout ${{ github.head_ref }}
          git pull origin ${{ github.head_ref }}
          npm install
          npm run build-react
          pm2 restart testing-app || pm2 start npm --name testing-app -- start

    - name: Email on Success
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.DEV_EMAIL }}
        password: ${{ secrets.DEV_EMAIL_PASSWORD }}
        subject: "✅ Testing Deployment Successful"
        to: ${{ secrets.DEV_EMAIL }}
        from: GitHub Actions
        body: |
          Testing deployment successful.

          PR Branch: ${{ github.head_ref }}
          Access app:
          http://${{ secrets.TESTING_EC2_IP }}:3000

    - name: Email on Failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.DEV_EMAIL }}
        password: ${{ secrets.DEV_EMAIL_PASSWORD }}
        subject: "❌ Testing Deployment Failed"
        to: ${{ secrets.DEV_EMAIL }}
        from: GitHub Actions
        body: |
          Deployment to Testing failed.
          Check GitHub Actions logs.
